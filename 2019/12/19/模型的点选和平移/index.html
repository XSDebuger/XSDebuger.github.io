<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模型的点选和平移 | 萧山码农</title>
    <meta name="description" content="
基本原理

点选

&gt; 模型的点击选中也是我们常常能看到的功能，在3D绘图软件和游戏中都有很广泛的应用。一般来说，实现它的方式有两种，一种是射线选择法，另一种则是我们使用的在帧缓存中存储特有颜色或id的方法。

射线选择法的基本原理就是，当点选某个像素时，我们看作从观察点向该方向发出一条射线。这条射线与哪个模型相交，就等于选中了哪个模型。射线选择法被许多著名的3D库使用，包括Th ...">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.b9adda82.css" as="style"><link rel="preload" href="/assets/js/app.5d19b8fa.js" as="script"><link rel="preload" href="/assets/js/9.785256bf.js" as="script"><link rel="preload" href="/assets/js/7.5b24e917.js" as="script"><link rel="preload" href="/assets/js/17.19e6dac1.js" as="script"><link rel="prefetch" href="/assets/js/1.468c81c5.js"><link rel="prefetch" href="/assets/js/10.6df78991.js"><link rel="prefetch" href="/assets/js/11.23a1f3de.js"><link rel="prefetch" href="/assets/js/12.81c370ce.js"><link rel="prefetch" href="/assets/js/13.2d1c06ef.js"><link rel="prefetch" href="/assets/js/14.42a69f97.js"><link rel="prefetch" href="/assets/js/15.fa42f190.js"><link rel="prefetch" href="/assets/js/16.a41cc8a3.js"><link rel="prefetch" href="/assets/js/18.5fc62336.js"><link rel="prefetch" href="/assets/js/19.c275d46b.js"><link rel="prefetch" href="/assets/js/20.d67102d1.js"><link rel="prefetch" href="/assets/js/21.39229d98.js"><link rel="prefetch" href="/assets/js/22.09e8a15a.js"><link rel="prefetch" href="/assets/js/23.3f34f348.js"><link rel="prefetch" href="/assets/js/24.1489dc2a.js"><link rel="prefetch" href="/assets/js/25.857dc890.js"><link rel="prefetch" href="/assets/js/26.ab567800.js"><link rel="prefetch" href="/assets/js/27.5ab9a097.js"><link rel="prefetch" href="/assets/js/28.c8795ca2.js"><link rel="prefetch" href="/assets/js/29.65a21c73.js"><link rel="prefetch" href="/assets/js/5.cdfe8ec9.js"><link rel="prefetch" href="/assets/js/6.7ab562dc.js"><link rel="prefetch" href="/assets/js/8.45daed47.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.908db966.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.bd4608b1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b9adda82.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">萧山码农 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">萧山码农 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="模型的点选和平移"><a href="#模型的点选和平移" class="header-anchor">#</a> 模型的点选和平移</h1> <h2 id="基本原理"><a href="#基本原理" class="header-anchor">#</a> 基本原理</h2> <h3 id="点选"><a href="#点选" class="header-anchor">#</a> 点选</h3> <blockquote><p>模型的点击选中也是我们常常能看到的功能，在3D绘图软件和游戏中都有很广泛的应用。一般来说，实现它的方式有两种，一种是射线选择法，另一种则是我们使用的在帧缓存中存储特有颜色或id的方法。</p></blockquote> <p>射线选择法的基本原理就是，当点选某个像素时，我们看作从观察点向该方向发出一条射线。这条射线与哪个模型相交，就等于选中了哪个模型。射线选择法被许多著名的3D库使用，包括Three.js。射线选择法的好处是比较通用，但实现起来需要判断射线和片元的交点，比较繁琐。</p> <p>我们使用的方法是在用户点击画布时，离屏渲染一张图片，顶点着色器和实际显示所用的一致，片元着色器仅仅为片元涂上给定的颜色。通过<code>gl.readPixels</code>方法，就可以读出当前鼠标点击的位置的颜色，进而判断点中了什么模型。此时帧缓存中的图像如下图所示。</p> <p><img src="data:image/png;base64,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" alt="帧缓存中的图像"></p> <h3 id="平移"><a href="#平移" class="header-anchor">#</a> 平移</h3> <p>选中模型后就需要平移。最简单的做法是，将鼠标在x,y轴上的移动直接映射到模型的x,y轴平移上。但是我们的视点会移动，当其朝向不再朝向正z轴方向时，这一移动就会与用户的心理预期不符。如何修正这种偏移呢？我们使用投影-视图-世界-模型矩阵的乘积的逆矩阵，与鼠标移动的向量相乘，得到的值作为模型的平移参数。这样做的好处是，不论视点如何变化，用户的鼠标平移都会在屏幕上表现得方向一致。</p> <h2 id="设计思路"><a href="#设计思路" class="header-anchor">#</a> 设计思路</h2> <p>本事件的流程图如下：</p> <div class="vuepress-flowchart loading"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 30 30" class="vuepress-flowchart-loading-icon" style="enable-background:new 0 0 50 50;"><rect x="0" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="10" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="20" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate></rect></svg></div><p>加上跟踪球后的流程如图：</p> <div class="vuepress-flowchart loading"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 30 30" class="vuepress-flowchart-loading-icon" style="enable-background:new 0 0 50 50;"><rect x="0" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="10" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="20" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate></rect></svg></div><p>属于基本的流程控制和事件侦听，此处不过多叙述。</p> <h2 id="具体实现"><a href="#具体实现" class="header-anchor">#</a> 具体实现</h2> <p>顶点着色器和主着色器共用代码，因此略过。片段着色器的代码如下：</p> <div class="language-GLSL extra-class"><pre class="language-glsl"><code><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> v_Color<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	gl_FragColor<span class="token operator">=</span>v_Color<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实十分类似产生阴影深度的着色器代码，只是改为附上颜色罢了。</p> <p>接下来是JavaScript中事件侦听的代码：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">//鼠标点击事件</span>
canvas<span class="token punctuation">.</span><span class="token function-variable function">onmousedown</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> bbox <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> x <span class="token operator">=</span> event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> bbox<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
      <span class="token keyword">var</span> y <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height<span class="token operator">-</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> bbox<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">bindFramebufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>fbi2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> readout<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">1</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//绘制hit帧</span>
      twgl<span class="token punctuation">.</span><span class="token function">bindFramebufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>fbi2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">.</span>program <span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span>light_uniform<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> hit_programInfo<span class="token punctuation">,</span> catBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span> cat_uniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span> projection_uniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span> view_uniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> catBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

      twgl<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>hit_programInfo<span class="token punctuation">,</span>boardBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      board_uniform<span class="token punctuation">.</span>uWorld<span class="token operator">=</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">setTranslation</span><span class="token punctuation">(</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span> board_uniform<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span> projection_uniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>hit_programInfo<span class="token punctuation">,</span> view_uniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>
      twgl<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>boardBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">readPixels</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>readout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>readout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_cat</span><span class="token punctuation">(</span>readout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            mouseFlag<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            catMove<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            lastMousePosX<span class="token operator">=</span>x<span class="token punctuation">;</span>
            lastMousePosY<span class="token operator">=</span>y<span class="token punctuation">;</span>
            cat_uniforms<span class="token punctuation">.</span>u_texture<span class="token operator">=</span>tex3<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            mouseFlag<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            trackBall<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            lastMousePosX<span class="token operator">=</span>x<span class="token punctuation">;</span>
            lastMousePosY<span class="token operator">=</span>y<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      twgl<span class="token punctuation">.</span><span class="token function">bindFramebufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//鼠标滚轮事件</span>
canvas<span class="token punctuation">.</span><span class="token function-variable function">onmousewheel</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> dy<span class="token operator">=</span>event<span class="token punctuation">.</span>deltaY<span class="token punctuation">;</span>
      camera_uniform<span class="token punctuation">.</span>u_viewWorldPosition<span class="token operator">=</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>dy<span class="token operator">*</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>camera_uniform<span class="token punctuation">.</span>u_viewWorldPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//鼠标移动事件</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousemove&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>mouseFlag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> bbox <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> bbox<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
    <span class="token keyword">var</span> y <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height<span class="token operator">-</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> bbox<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>height<span class="token operator">/</span>bbox<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> dx<span class="token operator">=</span>x<span class="token operator">-</span>lastMousePosX<span class="token punctuation">;</span>
    <span class="token keyword">var</span> dy<span class="token operator">=</span>y<span class="token operator">-</span>lastMousePosY<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ratio_x<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token operator">-</span>lastMousePosX<span class="token punctuation">)</span><span class="token operator">/</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ratio_y<span class="token operator">=</span><span class="token punctuation">(</span>y<span class="token operator">-</span>lastMousePosY<span class="token punctuation">)</span><span class="token operator">/</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>catMove<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> offset<span class="token operator">=</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>invMat<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        offset<span class="token operator">=</span>twgl<span class="token punctuation">.</span>v3<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>invMat<span class="token punctuation">,</span><span class="token punctuation">[</span>dx<span class="token punctuation">,</span>dy<span class="token punctuation">,</span><span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>light_uniform<span class="token punctuation">.</span>uShadow_type<span class="token punctuation">)</span><span class="token punctuation">{</span>
            twgl<span class="token punctuation">.</span>v3<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">changeCatLocation</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ratioX<span class="token punctuation">,</span>ratioY<span class="token punctuation">,</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> r_x <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>x <span class="token operator">*</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token operator">/</span>bbox<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token operator">/</span>canvas<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> r_y <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>y<span class="token operator">/</span>canvas<span class="token punctuation">.</span>height<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> last_rx<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>lastMousePosX<span class="token operator">*</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token operator">/</span>bbox<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token operator">/</span>canvas<span class="token punctuation">.</span>width<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> last_ry<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>lastMousePosY<span class="token operator">/</span>canvas<span class="token punctuation">.</span>height<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> ans <span class="token operator">=</span> <span class="token function">mouseMotion</span><span class="token punctuation">(</span>r_x<span class="token punctuation">,</span>last_ry<span class="token punctuation">,</span>last_rx<span class="token punctuation">,</span>r_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        camera_uniform<span class="token punctuation">.</span>u_viewWorldPosition<span class="token operator">=</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">axisRotate</span><span class="token punctuation">(</span>twgl<span class="token punctuation">.</span>m4<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ans<span class="token punctuation">.</span>axis<span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">*</span>ans<span class="token punctuation">.</span>angle<span class="token punctuation">)</span><span class="token punctuation">,</span>camera_uniform<span class="token punctuation">.</span>u_viewWorldPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    lastMousePosX<span class="token operator">=</span>x<span class="token punctuation">;</span>
    lastMousePosY<span class="token operator">=</span>y<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <!----> <hr> <!----></div> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#基本原理" title="基本原理">基本原理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#点选" title="点选">点选</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#平移" title="平移">平移</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#设计思路" title="设计思路">设计思路</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#具体实现" title="具体实现">具体实现</a></div></div></div></div> <footer class="footer" data-v-582f9766><div class="footer-left-wrap" data-v-582f9766><ul class="contact" data-v-582f9766><li class="contact-item" data-v-582f9766><a href="https://github.com/KXXH" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-582f9766><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-582f9766><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-582f9766></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-582f9766><ul class="copyright" data-v-582f9766><li class="copyright-item" data-v-582f9766><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-582f9766>Privacy Policy</a></li><li class="copyright-item" data-v-582f9766><a href="/2019/12/19/%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%82%B9%E9%80%89%E5%92%8C%E5%B9%B3%E7%A7%BB/.html" class="nav-link" data-v-582f9766>MIT Licensed | Copyright © 2018-present Vue.js</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5d19b8fa.js" defer></script><script src="/assets/js/9.785256bf.js" defer></script><script src="/assets/js/7.5b24e917.js" defer></script><script src="/assets/js/17.19e6dac1.js" defer></script>
  </body>
</html>
