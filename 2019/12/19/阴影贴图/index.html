<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>阴影贴图 | 萧山码农</title>
    <meta name="description" content="
基本原理

使用传统的方法实现阴影效果的基本思想是：太阳看不见阴影。

阴影纹理映射示意图

@flowstart

st=&gt;start: 开始
e=&gt;end: 结束
put_camera1=&gt;operation: 照相机放在光源位置
depth=&gt;operation: 算出片元深度
frame_buffer ...">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.b9adda82.css" as="style"><link rel="preload" href="/assets/js/app.5d19b8fa.js" as="script"><link rel="preload" href="/assets/js/9.785256bf.js" as="script"><link rel="preload" href="/assets/js/7.5b24e917.js" as="script"><link rel="preload" href="/assets/js/8.45daed47.js" as="script"><link rel="prefetch" href="/assets/js/1.468c81c5.js"><link rel="prefetch" href="/assets/js/10.6df78991.js"><link rel="prefetch" href="/assets/js/11.23a1f3de.js"><link rel="prefetch" href="/assets/js/12.81c370ce.js"><link rel="prefetch" href="/assets/js/13.2d1c06ef.js"><link rel="prefetch" href="/assets/js/14.42a69f97.js"><link rel="prefetch" href="/assets/js/15.fa42f190.js"><link rel="prefetch" href="/assets/js/16.a41cc8a3.js"><link rel="prefetch" href="/assets/js/17.19e6dac1.js"><link rel="prefetch" href="/assets/js/18.5fc62336.js"><link rel="prefetch" href="/assets/js/19.c275d46b.js"><link rel="prefetch" href="/assets/js/20.d67102d1.js"><link rel="prefetch" href="/assets/js/21.39229d98.js"><link rel="prefetch" href="/assets/js/22.09e8a15a.js"><link rel="prefetch" href="/assets/js/23.3f34f348.js"><link rel="prefetch" href="/assets/js/24.1489dc2a.js"><link rel="prefetch" href="/assets/js/25.857dc890.js"><link rel="prefetch" href="/assets/js/26.ab567800.js"><link rel="prefetch" href="/assets/js/27.5ab9a097.js"><link rel="prefetch" href="/assets/js/28.c8795ca2.js"><link rel="prefetch" href="/assets/js/29.65a21c73.js"><link rel="prefetch" href="/assets/js/5.cdfe8ec9.js"><link rel="prefetch" href="/assets/js/6.7ab562dc.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.908db966.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.bd4608b1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b9adda82.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">萧山码农 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">萧山码农 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="阴影贴图"><a href="#阴影贴图" class="header-anchor">#</a> 阴影贴图</h1> <h2 id="基本原理"><a href="#基本原理" class="header-anchor">#</a> 基本原理</h2> <p>使用传统的方法实现阴影效果的基本思想是：<em>太阳看不见阴影</em>。</p> <p><img src="/assets/img/depth-map-generation.ee656290.svg" alt="阴影纹理映射示意图"></p> <div class="vuepress-flowchart loading"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 30 30" class="vuepress-flowchart-loading-icon" style="enable-background:new 0 0 50 50;"><rect x="0" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="10" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="20" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate></rect></svg></div><p>如图所示，如果将照相机放在光源位置，那么照相机所看到的即为光源所看到的场景。那么我们只要找出在这个场景中，光源看不到的片元，就是被阴影覆盖的片元。上述操作可以通过深度值来实现。具体的流程可见上图。</p> <h2 id="设计思路"><a href="#设计思路" class="header-anchor">#</a> <strong>设计思路</strong></h2> <p>由于阴影数据在镜面贴图和显示中都需要使用，因此必须首先计算。阴影贴图的着色器中，严格意义上只需要将坐标变换到正确位置，然后把z值保存即可。但为了调试方便，我还是为片元附上了颜色。</p> <h3 id="精度问题"><a href="#精度问题" class="header-anchor">#</a> 精度问题</h3> <p>在最初调试时，片元的<code>gl_FragColor</code>的RGB值为颜色，W值为深度。但发现精度不足。理论上8位浮点数 $[0,\frac{255}{256}]$ 能存放256位深度，但是实际上由下图可知，绝大部分<a href="%E6%A0%B9%E6%8D%AE%E5%AE%9E%E9%AA%8C%E7%BA%A6%E6%9C%8975%25%E7%9A%84%E5%80%BC%E8%90%BD%E5%9C%A8$%5B0.99,1%5D$%E5%8C%BA%E9%97%B4%E4%B8%8A%EF%BC%8C98.5%25%E7%9A%84%E5%80%BC%E9%87%8D%E5%A4%8D%E4%BA%86">^1</a>深度落在<code>0.01</code>的范围上。因此导致精度不足，阴影无法正常显示。于是使用32位数（RGBA）表示深度，实验发现效果良好<a href="%E5%9C%A8%E6%A3%80%E6%9F%A5%E7%9A%841000%E4%B8%AA%E6%A0%B7%E6%9C%AC%E4%B8%AD%EF%BC%8C%E6%B2%A1%E6%9C%89%E6%B7%B1%E5%BA%A6%E6%95%B0%E6%8D%AE%E9%87%8D%E5%A4%8D">^2</a>。</p> <p><img src="/assets/img/Figure_1.446078d2.png" alt="理想状态下的深度渐进曲线"></p> <p><img src="/assets/img/Figure_2.be79b246.png" alt="8位浮点数下的深度渐进曲线"></p> <h3 id="偏移问题"><a href="#偏移问题" class="header-anchor">#</a> 偏移问题</h3> <p>处理了精度问题，可以保证不会出现大部分深度值落在1上的问题。但是上述方法并不能实际解决阴影映射的问题。由于浮点数转化过程中的问题，会导致存储在RGBA中的深度值无法与矩阵计算出的片元-光源距离直接作相等比较，导致图形学中常见的马赫带或其他问题。在这里我遇到的问题是片元-光源距离始终大于深度值，可以通过下面两张图分析看出。</p> <p><img src="data:image/png;base64,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" alt="存储在RGBA中的深度值，指数放大600倍"></p> <p><img src="data:image/png;base64,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" alt="实际计算出的片元-光源距离"></p> <p>这时可以通过添加固定的偏移量的方法，消除这一误差。对于透视投影，我们选择了<code>0.00004</code>作为偏移量，实验结果比较理想。</p> <h3 id="软化阴影"><a href="#软化阴影" class="header-anchor">#</a> 软化阴影</h3> <p>通过上述步骤得到的阴影贴图，在实际显示的着色器中应用后，效果如下：</p> <p><img src="/assets/img/soft_shadow_1.2aa2c682.png" alt="锯齿明显的阴影"></p> <p>可以发现，阴影有着很明显的锯齿，过渡非常不均匀。这主要是由于片元中的坐标值是连续插值得到的，而纹理数据却是离散的这一矛盾而产生的。我们可以通过增加帧缓存的大小并通过加入超采样的方式，来计算出更加柔和真实的阴影。下图是增加超采样后的阴影效果。</p> <p><img src="/assets/img/soft_shadow_2.52f965f8.png" alt="柔和的阴影"></p> <p>我使用了非常简单的超采样算法。首先，设定帧缓存大小到<code>1024*1024</code>，其宽高都大约是显示分辨率的2倍。在片元着色器中，使用一个循环，计算出当前片元周围的16个像素点的深度值，换算出对应的阴影值，求其均值作为当前片元的阴影值。</p> <h3 id="局限性"><a href="#局限性" class="header-anchor">#</a> 局限性</h3> <blockquote><p>通过这种方式得到的阴影，永远都只能是硬阴影。</p></blockquote> <p>软阴影是由于光源具有大小而产生的。例如，现实生活中的日光灯，其光源形状是线性的长条，那么在其正下方的物体应该会产生许多较浅的阴影，而不是一个很深的阴影，因为在很大的范围内，日光灯都只有一部分能照到物体。但在我们的实现中，光源仅仅是摄像机放置的位置上的一个无穷小的点，点是没有大小的，因此对于所有片元都只有能照到和不能照到两种可能性。我们可以改变超采样算法，可以改变阴影覆盖的权重，但不能从根本上解决问题。使用光线追踪技术可以从根本上消灭这一问题。</p> <h2 id="具体实现"><a href="#具体实现" class="header-anchor">#</a> 具体实现</h2> <p>首先看生成深度数据的着色器。</p> <div class="language-GLSL extra-class"><pre class="language-glsl"><code><span class="token comment">//顶点着色器</span>
<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> vPosition<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> uModel<span class="token punctuation">;</span>	<span class="token comment">//模型变换矩阵</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> uWorld<span class="token punctuation">;</span>	<span class="token comment">//世界变换矩阵</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> uView<span class="token punctuation">;</span>		<span class="token comment">//视口变换</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> uProjection<span class="token punctuation">;</span>	<span class="token comment">//投影变换</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	gl_Position <span class="token operator">=</span> uProjection<span class="token operator">*</span>uView<span class="token operator">*</span>uWorld<span class="token operator">*</span>uModel<span class="token operator">*</span>vPosition<span class="token punctuation">;</span>	<span class="token comment">//直接计算坐标即可</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-GLSL extra-class"><pre class="language-glsl"><code><span class="token comment">//片元着色器</span>
<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> v_Color<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">vec4</span> bitShift <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">256.0</span><span class="token punctuation">,</span> <span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token punctuation">,</span> <span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">vec4</span> bitMask <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> rgbaDepth <span class="token operator">=</span> <span class="token function">fract</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>z <span class="token operator">*</span> bitShift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rgbaDepth <span class="token operator">-=</span> rgbaDepth<span class="token punctuation">.</span>gbaa <span class="token operator">*</span> bitMask<span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span>rgbaDepth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实现的代码很简单，主要是通过给定变换矩阵算出顶点的坐标，在片元着色器中将深度值存入RGBA表示的片元颜色中。</p> <p>再来看绘制实际显示的图像的片元着色器：</p> <div class="language-GLSL extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//...</span>
	<span class="token comment">//计算出当前片元对应深度数据的坐标(-1,1)=&gt;(0,1)</span>
	<span class="token keyword">vec3</span> shadowCoord <span class="token operator">=</span> <span class="token punctuation">(</span>v_PositionFromLight<span class="token punctuation">.</span>xyz<span class="token operator">/</span>v_PositionFromLight<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
	<span class="token comment">//...</span>
	<span class="token comment">//计算当前片元阴影值</span>
	<span class="token keyword">vec4</span> rgbaDepth<span class="token punctuation">;</span>
    <span class="token keyword">float</span> shadows<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> depth<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">float</span> y<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">;</span>y<span class="token operator">&lt;=</span><span class="token number">1.5</span><span class="token punctuation">;</span>y<span class="token operator">+=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1.5</span><span class="token punctuation">;</span>x<span class="token operator">&lt;=</span><span class="token number">1.5</span><span class="token punctuation">;</span>x<span class="token operator">+=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token comment">//从深度数据纹理中提取并还原出深度数据</span>
            rgbaDepth<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_ShadowMap<span class="token punctuation">,</span> shadowCoord<span class="token punctuation">.</span>xy<span class="token operator">+</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span>texelSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            depth <span class="token operator">=</span> <span class="token function">unpackDepth</span><span class="token punctuation">(</span>rgbaDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//不同投影方式需要不同的偏移值</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>uShadow_type<span class="token punctuation">)</span>
            	<span class="token comment">//如果当前片元深度比取出的深度数据大，则在阴影中</span>
                shadows<span class="token operator">+=</span><span class="token punctuation">(</span>shadowCoord<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> depth <span class="token operator">+</span> <span class="token number">0.00004</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0.0</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                shadows<span class="token operator">+=</span><span class="token punctuation">(</span>shadowCoord<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> depth <span class="token operator">+</span> <span class="token number">0.002</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0.0</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    shadows<span class="token operator">/=</span><span class="token number">16.0</span><span class="token punctuation">;</span>	<span class="token comment">//求均值</span>
    <span class="token comment">//...</span>
    gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*=</span> shadows<span class="token punctuation">;</span>   <span class="token comment">//阴影覆盖在漫反射项</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在WebGL的实现上，首先需要创建一个帧缓存，并把纹理绑定给全局变量：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> attachments <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> format<span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> type<span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> min<span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> format<span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
fbi <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createFramebufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>attachments<span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
light_uniform<span class="token punctuation">.</span>u_ShadowMap<span class="token operator">=</span>fbi<span class="token punctuation">.</span>attachments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>在渲染时，先切换到对应着色器程序，绑定帧缓存并绘图。绘图完成后还原帧缓存绑定，再使用主着色器程序就可以访问到纹理了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      	<span class="token comment">//...</span>
        <span class="token comment">//绘制阴影</span>
        twgl<span class="token punctuation">.</span><span class="token function">bindFramebufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>fbi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>shadow_programInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
        twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>shadow_programInfo<span class="token punctuation">,</span> shadow_uniform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        twgl<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>shadow_programInfo<span class="token punctuation">,</span>boardBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        twgl<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>boardBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        twgl<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> shadow_programInfo<span class="token punctuation">,</span> catBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        twgl<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> catBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
		<span class="token comment">//...</span>
        <span class="token comment">//绘制可见帧</span>
        twgl<span class="token punctuation">.</span><span class="token function">bindFramebufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>programInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        twgl<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>programInfo<span class="token punctuation">,</span>light_uniform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
        twgl<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> programInfo<span class="token punctuation">,</span> catBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        twgl<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> catBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        twgl<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>programInfo<span class="token punctuation">,</span>boardBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        twgl<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>boardBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//...</span>
       	<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></div> <!----> <hr> <!----></div> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#基本原理" title="基本原理">基本原理</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#设计思路" title="设计思路">设计思路</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#精度问题" title="精度问题">精度问题</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#偏移问题" title="偏移问题">偏移问题</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#软化阴影" title="软化阴影">软化阴影</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#局限性" title="局限性">局限性</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#具体实现" title="具体实现">具体实现</a></div></div></div></div> <footer class="footer" data-v-582f9766><div class="footer-left-wrap" data-v-582f9766><ul class="contact" data-v-582f9766><li class="contact-item" data-v-582f9766><a href="https://github.com/KXXH" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-582f9766><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-582f9766><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-582f9766></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-582f9766><ul class="copyright" data-v-582f9766><li class="copyright-item" data-v-582f9766><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-582f9766>Privacy Policy</a></li><li class="copyright-item" data-v-582f9766><a href="/2019/12/19/%E9%98%B4%E5%BD%B1%E8%B4%B4%E5%9B%BE/.html" class="nav-link" data-v-582f9766>MIT Licensed | Copyright © 2018-present Vue.js</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5d19b8fa.js" defer></script><script src="/assets/js/9.785256bf.js" defer></script><script src="/assets/js/7.5b24e917.js" defer></script><script src="/assets/js/8.45daed47.js" defer></script>
  </body>
</html>
